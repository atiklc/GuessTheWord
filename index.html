<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GuessTheWord - Çok Oyunculu</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f3f6fc;margin:0;padding:24px;display:flex;justify-content:center}
    .card{width:min(95vw,840px);background:#fff;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.08);padding:20px}
    .row{display:grid;gap:8px;margin:10px 0} input,button{padding:10px;border-radius:8px;border:1px solid #cbd5e1}
    button{background:#2563eb;color:#fff;border:none;cursor:pointer}.secondary{background:#64748b}
    .hidden{display:none}.ok{color:#166534}.err{color:#b91c1c}
  </style>
</head>
<body>
  <main class="card">
    <h1>Kelime Tahmin Oyunu (Çok Oyunculu)</h1>

    <section id="authSection">
      <h3>Oda Oluştur</h3>
      <div class="row"><input id="hostName" placeholder="İsminiz (host)" /><input id="roundCount" type="number" min="1" value="3" /><button id="createBtn">Oda Oluştur</button></div>
      <h3>Odaya Katıl</h3>
      <div class="row"><input id="joinName" placeholder="İsminiz" /><input id="joinCode" placeholder="Oda kodu" /><button id="joinBtn">Katıl</button></div>
      <p id="authMsg"></p>
    </section>

    <section id="roomSection" class="hidden">
      <p><b>Oda:</b> <span id="roomCode"></span></p>
      <p><b>Durum:</b> <span id="statusText"></span></p>
      <p><b>Tur:</b> <span id="roundText"></span></p>
      <p><b>Oyuncular:</b> <span id="playersText"></span></p>
      <button id="startBtn" class="hidden">Oyunu Başlat (Host)</button>

      <div id="playArea" class="hidden">
        <p><b>İpucu:</b> <span id="hint"></span></p>
        <p><b>Kelime Uzunluğu:</b> <span id="wordLength"></span></p>
        <div class="row"><input id="guessInput" placeholder="Tahmin" /><button id="submitBtn">Yanıtı Gönder</button></div>
        <p id="waitingText"></p>
      </div>

      <div id="resultArea" class="hidden">
        <h3>Tur Sonucu</h3>
        <p>Doğru bilenler (sırayla): <span id="winners"></span></p>
        <ol id="leaderboard"></ol>
        <button id="nextRoundBtn" class="hidden">Sonraki Tura Geç (Host)</button>
      </div>

      <div id="finalArea" class="hidden">
        <h3>Oyun Bitti</h3>
        <ol id="finalLeaderboard"></ol>
      </div>
    </section>
  </main>

  <script>
    const state = {roomCode:'', playerId:'', isHost:false};
    const $ = (id) => document.getElementById(id);

    async function api(path, method='GET', body=null){
      const opts = {method, headers:{'Content-Type':'application/json'}};
      if(body) opts.body = JSON.stringify(body);
      const res = await fetch(path, opts);
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || 'Hata');
      return data;
    }

    function setMsg(id, text, cls='') { const el=$(id); el.textContent=text; el.className=cls; }

    $('createBtn').onclick = async () => {
      try {
        const host_name = $('hostName').value.trim();
        const total_rounds = Number($('roundCount').value);
        const data = await api('/api/create', 'POST', {host_name, total_rounds});
        state.roomCode = data.room_code; state.playerId = data.player_id; state.isHost = true;
        $('authSection').classList.add('hidden'); $('roomSection').classList.remove('hidden');
        refreshState();
      } catch (e) { setMsg('authMsg', e.message, 'err'); }
    };

    $('joinBtn').onclick = async () => {
      try {
        const name = $('joinName').value.trim();
        const room_code = $('joinCode').value.trim();
        const data = await api('/api/join', 'POST', {name, room_code});
        state.roomCode = data.room_code; state.playerId = data.player_id; state.isHost = false;
        $('authSection').classList.add('hidden'); $('roomSection').classList.remove('hidden');
        refreshState();
      } catch (e) { setMsg('authMsg', e.message, 'err'); }
    };

    $('startBtn').onclick = async () => {
      try { await api('/api/start', 'POST', {room_code:state.roomCode, player_id:state.playerId}); refreshState(); }
      catch (e) { alert(e.message); }
    };

    $('submitBtn').onclick = async () => {
      const guess = $('guessInput').value.trim();
      if(!guess) return;
      try {
        await api('/api/submit', 'POST', {room_code:state.roomCode, player_id:state.playerId, guess});
        $('guessInput').value = '';
        refreshState();
      } catch (e) { alert(e.message); }
    };

    $('nextRoundBtn').onclick = async () => {
      try { await api('/api/next-round', 'POST', {room_code:state.roomCode, player_id:state.playerId}); refreshState(); }
      catch (e) { alert(e.message); }
    };

    function renderBoard(listId, leaderboard){
      const list = $(listId); list.innerHTML='';
      leaderboard.forEach((r)=>{ const li=document.createElement('li'); li.textContent=`${r.name}: ${r.score} puan`; list.appendChild(li); });
    }

    async function refreshState(){
      if(!state.roomCode || !state.playerId) return;
      try {
        const s = await api(`/api/state?room_code=${state.roomCode}&player_id=${state.playerId}`);
        $('roomCode').textContent = s.room_code;
        $('statusText').textContent = s.status;
        $('roundText').textContent = `${s.current_round} / ${s.total_rounds}`;
        $('playersText').textContent = s.players.map(p=>p.name).join(', ');

        $('startBtn').classList.toggle('hidden', !(s.is_host && s.status==='waiting'));
        $('playArea').classList.toggle('hidden', s.status!=='playing');
        $('resultArea').classList.toggle('hidden', !(s.status==='round_result'));
        $('finalArea').classList.toggle('hidden', s.status!=='finished');

        if(s.status==='playing'){
          $('hint').textContent = s.hint;
          $('wordLength').textContent = s.word_length;
          const remaining = s.total_players - s.submitted_count;
          $('waitingText').textContent = s.player_submitted
            ? `Yanıtınız alındı. Diğer oyuncular bekleniyor (${remaining}).`
            : `Yanıtını gönderen: ${s.submitted_count}/${s.total_players}`;
          $('submitBtn').disabled = s.player_submitted;
          $('guessInput').disabled = s.player_submitted;
        }

        if(s.status==='round_result'){
          $('winners').textContent = s.round_winners.length ? s.round_winners.join(', ') : 'Bu tur doğru tahmin yok';
          renderBoard('leaderboard', s.leaderboard);
          $('nextRoundBtn').classList.toggle('hidden', !s.is_host);
        }

        if(s.status==='finished'){
          renderBoard('finalLeaderboard', s.leaderboard);
        }
      } catch (e) {
        setMsg('authMsg', e.message, 'err');
      }
    }

    setInterval(refreshState, 1500);
  </script>
</body>
</html>
